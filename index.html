<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crossover Fog Forecast</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; background-color: #f0f2f5; margin: 0; padding: 20px; }
        h2 { color: #333; margin-bottom: 5px; }
        .header-info { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: inline-block; margin-bottom: 20px; }
        .controls button { background-color: #533b8f; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background 0.2s; }
        .controls button:hover { background-color: #3e2a6e; }
        .controls button:active { transform: translateY(1px); }
        #map-container { position: relative; max-width: 1000px; margin: 0 auto; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        img { width: 100%; height: auto; border-radius: 4px; }
        #status-msg { font-size: 0.9em; color: #666; margin-top: 5px; }
        .loading { opacity: 0.5; }
    </style>
</head>
<body>

    <div class="header-info">
        <h2>Crossover Fog Forecast</h2>
        <div id="status-msg">Initializing...</div>
    </div>

    <div class="controls">
        <button onclick="changeFrame(-1)">&#8592; Prev</button>
        <button onclick="toggleLoop()" id="loop-btn">Start Loop</button>
        <button onclick="changeFrame(1)">Next &#8594;</button>
    </div>

    <div id="map-container">
        <img id="forecast-img" src="" alt="Loading Forecast Map...">
    </div>

    <script>
        let currentRunId = null;
        let currentFrame = 1;
        const maxFrames = 18;
        let loopInterval = null;

        // Load the JSON Status file first
        async function loadStatus() {
            try {
                // Add a timestamp to prevent browser caching of the JSON file
                const response = await fetch(`images/current_status.json?t=${new Date().getTime()}`);
                if (!response.ok) throw new Error("Status file not found");
                
                const data = await response.json();
                currentRunId = data.run_id;
                
                document.getElementById('status-msg').innerHTML = 
                    `<strong>Run:</strong> ${data.model_init} (Init) | <strong>Updated:</strong> ${data.generated_at}`;
                
                updateImage();
            } catch (error) {
                console.error(error);
                document.getElementById('status-msg').innerText = "System Offline or Updating...";
                document.getElementById('forecast-img').alt = "Map Unavailable";
            }
        }

        function updateImage() {
            if (!currentRunId) return;

            const img = document.getElementById('forecast-img');
            const frameStr = currentFrame.toString().padStart(2, '0');
            // Construct the URL based on the JSON run_id
            const url = `images/fog_${currentRunId}_f${frameStr}.png`;
            
            img.src = url;
        }

        function changeFrame(step) {
            currentFrame += step;
            if (currentFrame > maxFrames) currentFrame = 1;
            if (currentFrame < 1) currentFrame = maxFrames;
            updateImage();
        }

        function toggleLoop() {
            const btn = document.getElementById('loop-btn');
            if (loopInterval) {
                clearInterval(loopInterval);
                loopInterval = null;
                btn.innerText = "Start Loop";
                btn.style.backgroundColor = "#533b8f";
            } else {
                loopInterval = setInterval(() => changeFrame(1), 500);
                btn.innerText = "Stop Loop";
                btn.style.backgroundColor = "#d9534f";
            }
        }

        // Initialize
        loadStatus();
    </script>
</body>
</html>
